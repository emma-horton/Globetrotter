<HTML>
    <head>
        <!-- Importing D3.js for data visualization -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <style>
            /* Setting the width and height for html, body, div, and svg elements to occupy full page */
            html, body, div, svg {
                width: 100%;
                height: auto;
            }
    
            /* Styling for rectangles (bars in the bar chart) */
            rect {
                fill: gold;
                stroke: black;
                stroke-width: 2px;
            }
    
            /* Styling for tooltip text */
            .tooltip {
                font-size: 20px;
            }
    
            /* Styling for axis paths and lines */
            .axis path,
            .axis line {
                fill: none;
                stroke: black;
                shape-rendering: crispEdges;
            }
    
            /* Styling for axis labels */
            .axis text {
                font-size: 10px;
            }
            #sliderContainer {
                width: 80%;
                margin: 20px auto;
            }
            
            input[type=range] {
                -webkit-appearance: none; /* Override default appearance */
                appearance: none;
                width: 100%; /* Full-width */
                height: 10px; /* Specified height */
                background: #ddd; /* Grey background */
                outline: none; /* Remove outline */
                opacity: 0.7; /* Set transparency (cross-browser) */
                -webkit-transition: .2s; /* 0.2 seconds transition on hover */
                transition: opacity .2s;
            }
            
            input[type=range]::-webkit-slider-thumb {
                -webkit-appearance: none; /* Override default look */
                appearance: none;
                width: 20px; /* Set a specific slider handle width */
                height: 20px; /* Slider handle height */
                background: #4CAF50; /* Green background */
                cursor: pointer; /* Cursor on hover */
            }
            
            input[type=range]::-moz-range-thumb {
                width: 20px; /* Set a specific slider handle width */
                height: 20px; /* Slider handle height */
                background: #4CAF50; /* Green background */
                cursor: pointer; /* Cursor on hover */
            }
            
        </style>
    </head>
    <body>
        <!-- Page heading -->
        <h2>Top 5 Countries by Life Expectancy</h2>
        <!-- Container for the SVG visualization -->
        <div id="myDiv">
            <svg></svg>
        </div>
        <div id="sliderContainer">
            <label for="yearSlider">Year: <span id="sliderValue">1800</span></label>
            <input type="range" id="yearSlider" min="1800" max="2024" value="1800" step="1">
        </div>
        
        <script>
            // Loading and processing the CSV data
            d3.csv("reformatted_data/reformatted_life_expectancy.csv").then(function(data) {
                // Setting margins and dimensions for the SVG canvas
                const margin = {top: 10, right: 20, bottom: 50, left: 100},
                      svgWidth = 960,
                      svgHeight = 250,
                      width = svgWidth - margin.left - margin.right,
                      height = svgHeight - margin.top - margin.bottom;
    
                // Creating an SVG group element to offset the chart for the margins
                const svg = d3.select("svg")
                              .attr("width", svgWidth)
                              .attr("height", svgHeight)
                            .append("g")
                              .attr("transform", `translate(${margin.left},${margin.top})`);
    
                // Defining the x-axis scale based on life expectancy data
                const x = d3.scaleLinear()
                            .domain([0, d3.max(data, d => +d.life_expectancy)])
                            .range([0, width]);
    
                // Adding the bottom axis to the SVG group
                svg.append("g")
                   .attr("transform", `translate(0,${height})`)
                   .call(d3.axisBottom(x));
                   
                // Adding label for the x-axis
                svg.append("text")             
                   .attr("transform",
                         "translate(" + (width/2) + " ," + 
                                        (height + margin.top + 20) + ")")
                   .style("text-anchor", "middle")
                   .text("Life Expectancy");
    
                // Adding label for the y-axis
                svg.append("text")
                   .attr("transform", "rotate(-90)")
                   .attr("y", 0 - margin.left)
                   .attr("x",0 - (height / 2))
                   .attr("dy", "1em")
                   .style("text-anchor", "middle")
                   .text("Country"); 
    
                // Converting life expectancy data to numeric type
                data.forEach(function(d) {
                    d.life_expectancy = +d.life_expectancy;
                });
    
                // Sorting data to get top five countries by life expectancy
                data.sort(function(a, b) {
                    return b.life_expectancy - a.life_expectancy;
                });
    
                let topFive = data.slice(0, 5);
                console.log(topFive)

                // Calculating dimensions for bars in the bar chart
                const barHeight = 20;
                const barSpacing = 20; 
                const totalBarsHeight = topFive.length * (barHeight + barSpacing) - barSpacing;
                const startY = height - totalBarsHeight; 

                d3.select("#yearSlider").on("input", function() {
                    let year = this.value;
                    console.log(year)
                    d3.select("#sliderValue").text(year); // Update the label with the current year
                    filterDataAndUpdateChart(year); // Function to update the chart
                });
                        

                // Filter the data for the selected year
                function filterDataAndUpdateChart(selectedYear) {
                    let filteredData = data.filter(d => d.year === selectedYear);
                    console.log(filteredData);
                    updateTimeline(filteredData);
                }

                function updateTimeline(updatedData) {
                    // Clear existing bars and tooltips
                    svg.selectAll("rect").remove();
                    console.log(svg.selectAll(".label").size());
                    svg.selectAll(".label").remove();
                    svg.selectAll(".tooltip").remove(); // Assuming tooltips are appended directly to SVG. Adjust if necessary.
                
                    // You may want to recalculate the top five here based on the updated data
                    // Assuming updatedData is already filtered for the selected year
                    let topFiveUpdated = updatedData.sort((a, b) => b.life_expectancy - a.life_expectancy).slice(0, 5);
                    console.log(topFiveUpdated)

                    // Redraw bars for the top five countries
                    svg.selectAll("rect")
                       .data(topFiveUpdated)
                       .enter()
                       .append("rect")
                       .attr("x", 0)
                       .attr("y", (d, i) => startY + i * (barHeight + barSpacing))
                       .attr("width", d => x(+d.life_expectancy))
                       .attr("height", barHeight)
                       .on("mouseenter", function(event, d) {
                        d3.select(this)
                          .transition()
                          .duration(200)
                          .style("fill", "#FF9C00");
     
                        d3.select(svg.node().parentNode)
                          .append("text")
                          .attr("class", "tooltip")
                          .attr("x", event.x - margin.left)
                          .attr("y", event.y - margin.top)
                          .text(`Average life expectancy: ${d.life_expectancy}`);
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                          .transition()
                          .duration(200)
                          .style("fill", "gold");
     
                        d3.selectAll(".tooltip").remove();
                    });
                
                    // Adding country labels for the new bars
                    svg.selectAll("text.label")
                        .data(topFiveUpdated)
                        .enter()
                        .append("text")
                        .attr("class", "label")
                        .attr("x", -5)
                        .attr("y", (d, i) => startY + i * (barHeight + barSpacing) + barHeight / 2 + 5)
                        .attr("text-anchor", "end")
                        .text(d => d.country);
                }       
            });
        </script>
    </body>
</HTML>
    